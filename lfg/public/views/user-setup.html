<link rel="import" href="../components/bower_components/polymer/polymer.html">
<link rel="import" href="../imports/layout.html">

<!-- Fonts -->
<link rel='import' href='../components/bower_components/font-roboto/roboto.html'>

<link rel="import" href="../components/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/av-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/image-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/notification-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/social-icons.html">

<link rel="import" href="../components/bower_components/iron-form/iron-form.html">

<link rel="import" href="../components/bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../components/bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../components/bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../components/bower_components/paper-item/paper-item.html">
<link rel="import" href="../components/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../components/bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../components/bower_components/paper-toolbar/paper-toolbar.html">

<!-- Custom Imports -->
<link rel="import" href="../imports/font-awesome.html">
<link rel="import" href="../imports/materialize.html" />
<link rel="import" href="../imports/material_icons.html" />
<link rel="import" href="../imports/flaticons.html" />
<!--<link rel="import" href="../imports/crypto-js.html" />-->


<dom-module id="user-setup">
	<!-- CSS -->
	<link rel="import" type="css" href='../assets/app/css/lfg.css'>

	<style>
		:host {
		}

		.content-area{
			margin-top:3%;
            background-color:#fb8c00;
        }

		#done-button.btn:hover, #done-button.btn-large:hover {
			background-color: #1b5e20;
		}

		.sign-in-flaticon-update {
			font-size: 50px !important;
			color: #ffffff;
			margin-top: -15px;
		}

		.regular-text {
			text-transform: none;
		}

		.sign-in-button {
			width: 300px;
		}
		.lfg-input{
            color: #ffeb3b !important;

        }

		.lfg-input.input-field textarea {
			border-bottom: 1px solid #ffffff;
            box-shadow: 0 1px 0 0 #ffffff;
		}

		.lfg-input.input-field textarea:focus {
			border-bottom: 1px solid #ffeb3b;
            box-shadow: 0 1px 0 0 #ffeb3b;
		}

        /* label color */
        .lfg-input.input-field label {
            color: #ffffff;
        }

        .lfg-input.input-field input[type=text]{
            border-bottom: 1px solid #ffffff;
            box-shadow: 0 1px 0 0 #ffffff;
            font-size: 1.5rem;
        }

		.lfg-input.input-field input[type=email]{
            border-bottom: 1px solid #ffffff;
            box-shadow: 0 1px 0 0 #ffffff;
            font-size: 1.5rem;
        }

        /* label focus color */
        .lfg-input.input-field input[type=text]:focus + label {
            color: #ffeb3b;
        }

		.lfg-input.input-field input[type=email]:focus + label {
            color: #ffeb3b;
        }

        /* label underline focus color */
        .lfg-input.input-field input[type=text]:focus {
            border-bottom: 1px solid #ffeb3b;
            box-shadow: 0 1px 0 0 #ffeb3b;
        }

		.lfg-input.input-field input[type=email]:focus {
            border-bottom: 1px solid #ffeb3b;
            box-shadow: 0 1px 0 0 #ffeb3b;
        }
        /* valid color */
        .lfg-input.input-field input[type=text].valid {
            border-bottom: 1px solid #ffffff;
            box-shadow: 0 1px 0 0 #ffffff;
        }

		.lfg-input.input-field input[type=email].valid {
            border-bottom: 1px solid #ffffff;
            box-shadow: 0 1px 0 0 #ffffff;
        }

        /* invalid color */
        .lfg-input.input-field input[type=text].invalid {
            border-bottom: 1px solid #f44336 !important;
            box-shadow: 0 1px 0 0 #f44336 !important;
        }

		.lfg-input.input-field input[type=email].invalid {
            border-bottom: 1px solid #f44336 !important;
            box-shadow: 0 1px 0 0 #f44336 !important;
        }

		.lfg-input .select-wrapper input.select-dropdown .invalid {
			border-bottom: 1px solid #f44336 !important;
            box-shadow: 0 1px 0 0 #f44336 !important;
		}

        /* Icon prefix */
        .lfg-input.input-field .prefix {
            color: #ffffff;
        }

        /* icon prefix focus color */
        .lfg-input.input-field .prefix.active {
            color: #ffeb3b;
        }

		.lfg-input .select-wrapper input.select-dropdown{
			border-bottom: 1px solid #ffffff;
            box-shadow: 0 1px 0 0 #ffffff;
		}
	</style>

	<template>
		<div fit class="container content-area">
			<br>
			<form id="new_request_form" class="col s12">
				<div class="row">
					<div class="lfg-input input-field col s12">
						<i class="material-icons prefix">account_circle</i>
						<input id="username" type="text" class="validate" on-keyup="changeUsername" />
						<label for="username">What should we call you?</label>
					</div>
				</div>
				<br />
				<div class="row">
					<div class="lfg-input input-field col s12">
						<i class="material-icons prefix">email</i>
						<input id="email" type="email" class="validate" value="{{user.email}}"/>
						<label for="email">What's your email? We promise, we won't spam your inbox</label>
					</div>
				</div>
				<br />
				<div class="row">
					<div class="col s12 center">
						<label class="white-text" style="font-size:1rem;">Upload a profle pic, so everyone can see just how cool you look.</label>
					</div>
					<div class="lfg-input input-field col s12 center" layout center>
						<div class="file-field" layout horizontal center-center>
							<div class="btn center center-aligned orange darken-4">
								<span><i class="material-icons left">backup</i> Upload</span>
								<input id="file_upload" type="file" accept="image/*" capture="camera" />
							</div>
						</div>
					</div>
				</div>
				<br /><br />
				<div class="row">
					<div class="col s12 center center-aligned">
						<img id="profile_pic" src="../assets/app/img/profile-photo-placeholder.png" alt="" class="circle responsive-img"  style="border:solid 2px #ffffff; height:125px; width:125px;">
					</div>
					<div class="col s12 center">
						<h4 class="light white-text" style="font-size:1.35rem;">{{user.username}}</h4>
					</div>
				</div>
				<br />
				<div class="row">
					<div class="col s12"  layout horizontal center-center>
						<a id="done-button" on-click="saveUserData" class="btn btn-flat btn-large waves-effect waves-light white-text" style="font-size:1.75rem;">
							<i class="material-icons left" style="font-size:2.3rem;">done</i>
							Done
						</a>
					</div>
				</div>
			</form>
		</div>
	</template>
</dom-module>

<script>
    (function(window) {
        var constructor = Polymer({

        	is: 'user-setup',

            /**
             * ...
             *
             * @attribute properties
             * @type object
             * @default
             */
            properties: {
            	name: 'User Setup'
            },

        	/* Functions */
            validateInput: function (userdata) {
            	var valid = true;

            	if (userdata.username === null || userdata.username === undefined || userdata.username === '') {
            		valid = false;
            	}

            	if (userdata.email === null || userdata.email === undefined || userdata.email === '' || !window.lfg.utils.checkEmail(userdata.email)) {
            		valid = false;
            	}

            	if (userdata.profilepic === null || userdata.profilepic === undefined) {
            		valid = false;
            	}
            	return valid;
            },

			/* Init */
            initializeData: function () {

            	this.user = {
            		username: "What we'll call you",
            		email: ''
            	};

            	this.firebaseUrl = window.lfg.config.getFirebaseUrl();
            	this.firebaseRef = new Firebase(window.lfg.config.getFirebaseUrl());
            },

            registerEvents: function () {
            	document.getElementById("file_upload").addEventListener('change', this.handleFileSelect.bind(this), false);
            },

            registerPlugins: function() {
            },

        	/* Events */
            changeUsername: function (e) {
            	//Despite how awesome Polymer 1.0 is, sometimes, you find some really annoying bugs in it - not complaining though
				//It's not "data-binding" if I have to "manually" set the property to persist it's value. This should be automatic!!!!!!!
            	var input = e.target;
            	this.set('user.username', input.value);
            },

            handleFileSelect: function (evt) {
            	//Thank you firepano over @ https://github.com/firebase/firepano
            	var cusElem = this;
            	var f = evt.target.files[0];
            	var reader = new FileReader();
            	reader.onload = (function (theFile) {
            		return function (e) {
            			var filePayload = e.target.result;
            			cusElem.user.profilepic = filePayload;
            			document.getElementById("profile_pic").src = e.target.result;
            			//$(cusElem.$.file_upload).hide();

            			// Generate a location that can't be guessed using the file's contents and a random number
            			//var hash = CryptoJS.SHA256(Math.random() + CryptoJS.SHA256(filePayload));

            			//var f = new Firebase(firebaseRef + 'pano/' + hash + '/filePayload');
            			//spinner.spin(document.getElementById('spin'));

            			// Set the file payload to Firebase and register an onComplete handler to stop the spinner and show the preview
            			//f.set(filePayload, function () {
            			//	spinner.stop();
            			//	document.getElementById("pano").src = e.target.result;
            			//	$('#file-upload').hide();
            			//	// Update the location bar so the URL can be shared with others
            			//	window.location.hash = hash;
            			//});
            		};
            	})(f);
            	reader.readAsDataURL(f);
            },

            saveUserData: function () {
            	//do some validation...
            	if (this.validateInput(this.user)) {
            		var authData = sessionStorage.getItem('authData');
            		var userRef = new Firebase(window.lfg.config.getFirebaseUrl() + 'users/' + authData.uid);
            		userRef.setvalue(this.user);
            	}
            },

            ready: function () {
            	this.initializeData();
            },

            attached: function () {
            	this.registerPlugins();
            	this.registerEvents();
            }
        });
    })(window);
</script>