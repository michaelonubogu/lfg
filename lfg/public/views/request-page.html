<link rel="import" href="../components/bower_components/polymer/polymer.html">
<link rel="import" href="../components/bower_components/polymer/layout.html">

<!-- Fonts -->
<link rel='import' href='../components/bower_components/font-roboto/roboto.html'>

<link rel="import" href="../components/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/av-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/image-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/notification-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/social-icons.html">

<link rel="import" href="../components/bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../components/bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../components/bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../components/bower_components/paper-item/paper-item.html">
<link rel="import" href="../components/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../components/bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../components/bower_components/paper-toolbar/paper-toolbar.html">

<!-- Google Custom Elements-->
<link rel="import" href="../components/bower_components/firebase-element/firebase-collection.html">


<dom-module id="request-page">
    <!-- CSS -->
    <link rel="import" type="css" href="../assets/materialize/css/materialize.css"  />
    <link rel="import" type="css" href='../assets/app/css/lfg.css'>

    <style>
        :host{
        }

        .logo-link{
            text-decoration: none;
            font-size:2rem;
            color:#ffffff;
            margin-left:-15px !important;
        }

        input[type=text].request-page{
             background-color: transparent;
              border: none;
              border-bottom: none !important;
              border-radius: 0;
              outline: none;
              height: 3rem;
              width: 100%;
              font-size: 1.5rem !important;
              font-weight:400;
              margin: 0 0 15px 0;
              padding: 0;
        }

        /* label underline focus color */
        input[type=text].request-page:focus {
            border-bottom: none;
            box-shadow: none;
        }
        /* valid color */
        input[type=text].request-page.valid {
            border-bottom: none !important;
            box-shadow: none !important;
        }
        /* invalid color */
        input[type=text].request-page.invalid {
            border-bottom: none;
            box-shadow: none;
        }

        .lfg-main-toolbar{
            --paper-toolbar-background:{
                 background-color: transparent !important;
             };
        }

        .lfg-drawer-toolbar{
            --paper-toolbar-background: #ef6c00;
        }

        #paper-header-panel{
            border-bottom: solid 1px #ffffff;
        }

        .lfg-main-header-panel{
            --paper-header-panel-cover-container:{
                border: solid 1px #ffffff;
             };
        }

        .lfg-paper-fab{
            --paper-fab: {
                position: fixed;
                right: 0;
                bottom: 0;
                 margin-right: 3%;
                 margin-bottom: 3%;
             };
            --paper-fab-background: #e65100;
        }

        .bottom-bar{
            margin-left:0px !important;
        }

        .content-area{
            padding:0 15% 15% 15%;
            background-color:#FAFAFA;
        }

        .requests-card-panel{
            width: 100%;
            box-shadow: 0 2px 5px 0 #e65100;
            border-radius:0px;
            height: 1200px !important;
        }


        @media (max-width: 640px){
            .logo-link{
                margin-left:0px;
            }

            .content-area{
                padding: 0;
            }

            .lfg-paper-fab{
                --paper-fab: {
                     position: fixed;
                     right: 0;
                     bottom: 0;
                     margin-right: 3.5%;
                     margin-bottom: 3.5%;
                 };
                --paper-fab-background: #e65100;
            }
        }
    </style>

    <template>
        <paper-drawer-panel>
            <paper-header-panel mode="seamed" drawer>
                <paper-toolbar class="tall lfg-drawer-toolbar">
                </paper-toolbar>
                <div fit class="orange darken-3"></div>
            </paper-header-panel>
            <paper-header-panel mode="waterfall-tall" main class="lfg-main-header-panel">
                <paper-toolbar class="tall lfg-main-toolbar">
                    <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
                    <!--<paper-icon-button icon="arrow-back"></paper-icon-button>-->
                    <div flex></div>
                    <paper-icon-button id="search_button" icon="search" on-click="showSearch"></paper-icon-button>
                    <paper-icon-button id="sort_menu" icon="sort" data-activates='dropdown1'></paper-icon-button>
					<!--<paper-icon-button id="filter_menu" icon="filter-list" on-click="showFilter"></paper-icon-button>-->

                    <ul id="search_dropdown" class="dropdown-content style-scope request-page active" style="min-height: 60px; top: 0px !important; left: 0px !important; min-width: 100% !important; position: absolute; opacity: 1; display: block;">
                        <li style="vertical-align: middle !important; min-height: 60px !important; cursor:auto;" class="style-scope request-page">
                            <div class="row style-scope request-page" style="min-height:100% !important; margin-bottom: 0px;">
                                <div class="col s1 style-scope request-page" style="margin-top:19px;">
                                    <paper-icon-button icon="arrow-back" class="grey-text text-darken-1 style-scope request-page x-scope paper-icon-button-0" role="button" tabindex="0" aria-disabled="false">
                                        <paper-ripple id="ink" class="circle style-scope paper-icon-button" center="">
                                            <div id="background" class="style-scope paper-ripple"></div>
                                            <div id="waves" class="style-scope paper-ripple"></div>
                                        </paper-ripple>
                                        <iron-icon id="icon" class="style-scope paper-icon-button x-scope iron-icon-0">
                                            <svg viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" class="style-scope iron-icon" style="pointer-events: none; display: block; width: 100%; height: 100%;"><g class="style-scope iron-icon"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" class="style-scope iron-icon"></path></g></svg>
                                            <iron-meta id="meta" type="iconset" class="style-scope iron-icon"></iron-meta>
                                        </iron-icon>
                                    </paper-icon-button>
                                </div>
                                <div class="col s11 style-scope request-page" style="margin-top: 18px; font-size:1.5rem;">
                                    <input id="search_input" type="text" class="validate style-scope request-page" placeholder="Game Title">
                                </div>
                            </div>
                        </li>
                        <!--<li class="divider search-result-item"></li>
                        <li class="search-result-item" style="padding: 7px 0px 7px 8.2%;"><a href="#!">Search</a></li>
                        <li><a href="#!">Results</a></li>
                        <li><a href="#!">Listed</a></li>
                        <li><a href="#!">Here</a></li>-->
                    </ul>
					<ul id='dropdown1' class='dropdown-content'>
						<template is="dom-repeat" items="[[sortoptions]]">
							<li><a on-click="changeSort" data-sort$="[[item.column]]">[[item.name]]</a></li>
						</template>
						<!--<li class="divider"></li>
						<li><a href="#!">three</a></li>-->
					</ul>
                    <div class="middle">
                    </div>
                    <div title class="bottom bottom-bar">
                        <a href="/" class="logo-link">Gaming Requests</a>
                    </div>
                </paper-toolbar>

                <div class="white" fit>
					<ul id="request_list" class="collection" style="margin-top:0;">
						
						<template is="dom-repeat" items="{{requests}}">
							<li class="collection-item avatar" style="padding-top:20px; padding-bottom:15px !important; height:auto !important;">
								<i class="mdi-social-person circle"></i>
								<span class="title" style="font-size:1.25rem;">[[item.gametitle]]</span>
								<p style="font-size:0.875rem;">[[item.title]]</p>
								<p class="grey-text truncate" style="font-size:0.8rem;">[[item.description]]</p>
								<p class="grey-text secondary-content" style="font-size:0.85rem;">[[formatDate(item.created)]]</p>
								<!--<p class="grey-text secondary-content" style="margin-top:35px; font-weight:600; text-transform:uppercase;">[[item.system]]</p>-->
							</li>
						</template>
					</ul>
                    <paper-fab icon="add" class="lfg-paper-fab" on-click="newRequest"></paper-fab>
                </div>
            </paper-header-panel>
        </paper-drawer-panel>

		<div id="filter_modal" class="modal bottom-sheet" style="display: block; opacity: 0; bottom: -100%;">
			<div class="modal-content">
				<h5>Filter Requests</h5>
				<ul class="collection">
					<li class="collection-item avatar">
						<i class="mdi-file-folder circle"></i>
						<span class="title">Title</span>
						<p>
							First Line <br>
							Second Line
						</p>
						<a href="#!" class="secondary-content"><i class="mdi-action-grade"></i></a>
					</li>
					<li class="collection-item avatar">
						<i class="mdi-file-folder circle"></i>
						<span class="title">Title</span>
						<p>
							First Line <br>
							Second Line
						</p>
						<a href="#!" class="secondary-content"><i class="mdi-action-grade"></i></a>
					</li>
					<li class="collection-item avatar">
						<i class="mdi-action-assessment circle green"></i>
						<span class="title">Title</span>
						<p>
							First Line <br>
							Second Line
						</p>
						<a href="#!" class="secondary-content"><i class="mdi-action-grade"></i></a>
					</li>
					<li class="collection-item avatar">
						<i class="mdi-av-play-arrow circle red"></i>
						<span class="title">Title</span>
						<p>
							First Line <br>
							Second Line
						</p>
						<a href="#!" class="secondary-content"><i class="mdi-action-grade"></i></a>
					</li>
				</ul>
			</div>
		</div>
    </template>
</dom-module>

<script>
    (function(window) {
        var constructor = Polymer({

            is: 'request-page',

            /**
             * ...
             *
             * @attribute properties
             * @type object
             * @default
             */
            properties: {
                firebase: {
                    requests: null,
                    games: null,
                    users: null
                },
                name: 'Requests Page',

                /**
                 * ...
                 *
                 * @attribute thingName
                 * @type string
                 * @default ''
                 */
				notify: true
            },

        	/* Functions */
            changeSort: function (e) {
            	var anchor_elem = e.target;
            	this.dataops.sort = anchor_elem.dataset.sort;

            	//this.getRequests(this.dataops.sort, true);
            	this.getRequests(null, this.querytype.none, false);
            },

            doSearch: function (e) {
            	var query = $('#search_input').val();

            	if ((e.keyCode || e.which) === 13) {
            		/* so the idea here is to take a the text and do a "LIKE" type of query to firebase using "startAt" and "endAt".
					 * I'm not sure atm, whether if/when the user selects the suggested option within the search window, I want to - 
					 * still do a "LIKE" search or do an "EQUAL TO" search. The user might select the title "Street Fighter" but actually
					 * not want street fighter from the 80s, but street fighter  4. Cuz we are using Giant Bomb as reference, whats returned in the
					 * autocomplete ties to a gameid.
					 *
					 * For now, I'm going to always do a "LIKE" Search. We'll see how it plays out :| */

            		this.dataops.query = query;		//save the query incase we need it for scrolling
            		//this.getRequests(this.dataops.sort, true, query.toLowerCase());
            		this.getRequests(query.toLowerCase(), this.querytype.bygame, false);
            		$('#search_dropdown').fadeOut(100);
            	}
            	else {
            		var url = window.lfg.config.getGiantBombUrl(window.lfg.config.apiEndPoints.search);

            		$.ajax({
            			url: url,
            			type: 'GET',
            			cache: false,
            			data: { search: query, limit: 4 },
            			dataType: 'json',
            			success: function (data) {
            				var html = '<li class="divider search-result-item"></li>';
            				$('#search_dropdown').find('.search-result-item').remove();

            				_.each(data.results, function (result) {
            					html += '<li class="search-result-item" data-result-id="' + result.id + '" style="padding: 7px 0px 7px 8.2%;"><a class="search-result-link">' + result.name + '</a></li>';
            				});
            				$('#search_dropdown').append(html);
            			},
            			error: function (err) {
            			}
            		});
            	}
            },

            doResultSearchWithClick: function (e) {
            	var polymer = this;		//bound to polymer elem
            	var anchor = e.target;

            	var li = $(anchor).parent();
            	var giantbombid = $(li).data('resultId');
            	var game = $(anchor).html().toLowerCase();
            	//polymer.getRequests(polymer.dataops.sort, true, game.toLowerCase(), giantbombid);
            	polymer.getRequests(giantbombid, this.querytype.byid, false);
            	e.preventDefault();
            },

            formatDate: function (utc) {
            	var date = new Date(utc);
            	return date.toString('MMMM dd, yyyy h:mm tt');
            },

            getRequests: function (query, querytype, paginate) {
            	var customElem = this
            	var requestsRef = this.firebaseRef.child('requests');

            	if (paginate) {
            		var lastrequest = this.requests[this.requests.length - 1];

            		//determine query type
            		switch (querytype) {
            			case this.querytype.bygame:
            				query = window.lfg.utils.clearWhiteSpace(query).toLowerCase();

            				//save the query & type (for pagination)
            				this.dataops.query = query;
            				this.dataops.querytype = querytype;

            				//Using a custom index I created to reverse order entries
            				requestsRef
								.orderByChild('gameindex')
								.startAt(lastrequest.gameindex)
								.limitToFirst(this.dataops.limit + 1)
								.on('child_added', function (snapshot) {
									var request = snapshot.val() || {};
									if (request.gameindex !== lastrequest.gameindex) { customElem.push('requests', request); };
								});
            				break;

            			case this.querytype.byid:
            				//save the query & type (for pagination)
            				this.dataops.query = query;
            				this.dataops.querytype = querytype;

            				requestsRef
								.orderByChild('giantbombindex')
								.startAt(lastrequest.giantbombindex)
								.limitToFirst(this.dataops.limit + 1)
								.on('child_added', function (snapshot) {
									var request = snapshot.val() || {};
									if (request.giantbombindex !== lastrequest.giantbombindex) { customElem.push('requests', request); };
								});
            				break;

            			default:
            				//no query, so just go by priority
            				//save the query & type (for pagination)
            				this.dataops.querytype = querytype;

            				requestsRef
								.orderByPriority()
								.startAt(lastrequest.priority)
								.limitToFirst(this.dataops.limit + 1)
								.on("child_added", function (snapshot) {
									var request = snapshot.val() || {};
									request.priority = snapshot.getPriority();
									if (request.priority !== lastrequest.priority) { customElem.push('requests', request); };
								}, function (errorObject) {
									console.log("The read failed: " + errorObject.code);
								});
            				break;
            		}
            	}
            	else {
            		this.requests = [];
            		switch (querytype) {
            			case this.querytype.bygame:          				
            				query = window.lfg.utils.clearWhiteSpace(query).toLowerCase();	//querying by game title, so prepare query    

            				//save the query & type (for pagination)
            				this.dataops.query = query;
            				this.dataops.querytype = querytype;

            				requestsRef				
								.orderByChild('gameindex')
								.startAt(query)
								.endAt(query + '~')
								.limitToFirst(this.dataops.limit)
								.on('child_added', function (snapshot) {
									var request = snapshot.val() || {};
									if (request !== lastrequest) { customElem.push('requests', request); };
								});
            				break;

            			case this.querytype.byid:

            				//save the query & type (for pagination)
            				this.dataops.query = query;
            				this.dataops.querytype = querytype;

            				requestsRef
								.orderByChild('giantbombindex')
								.startAt(id)
								.endAt(id + '~')
								.limitToFirst(this.dataops.limit)
								.on('child_added', function (snapshot) {
									var request = snapshot.val() || {};
									if (request !== lastrequest) { customElem.push('requests', request); };
								});
            				break;

            			default:
            				//save the query & type (for pagination)
            				this.dataops.querytype = querytype;

            				requestsRef
								.orderByPriority()
								.limitToFirst(this.dataops.limit)
								.on("child_added", function (snapshot) {
									var request = snapshot.val() || {};
									request.priority = snapshot.getPriority();
									if (request !== lastrequest) { customElem.push('requests', request); };
								}, function (errorObject) {
									console.log("The read failed: " + errorObject.code);
								});
            				break;
            		}
            	}
            },

            /*getRequests: function (orderby, clear, query, id, next) {
				var customElem = this
				var requestsRef = this.firebaseRef.child('requests');

				if (next) {
					var lastrequest = this.requests[this.request.length - 1];
					if (query !== null && query !== undefined && query !== '') {
						query = window.lfg.utils.clearWhiteSpace(query).toLowerCase();

						//Using a custom index I created to reverse order entries
						requestsRef
							.orderByChild('gameindex')
							.startAt(query).endAt(query + '~')
							.limitToFirst(this.dataops.limit + 1)
							.on('child_added', function (snapshot) {
								var request = snap.val() || {};
								if (request !== lastrequest) { customElem.push('requests', val); };
							});
					}
					else if (id !== null && id !== undefined && id !== '') {
						requestsRef
							.orderByChild('giantbombindex')
							.startAt(null, lastrequest)
							.endAt(id + '~')
							.limitToFirst(this.dataops.limit + 1)
							.on('child_added', function (snapshot) {
								var request = snap.val() || {};
								if (request !== lastrequest) { customElem.push('requests', val); };
							});
					}
					else {
						//going to query the gameindex so prep the game name
						query = window.lfg.utils.clearWhiteSpace(query).toLowerCase();

						requestsRef
							.orderByChild('gameindex')
							.startAt(null, lastrequest)	//pagination with firebase
							.endAt(query + '~')
							.limitToFirst(this.dataops.limit + 1)	//account for the last request
							.on('child_added', function (snapshot) {
								var request = snap.val() || {};
								if (request !== lastrequest) { customElem.push('requests', val); };
							});
					}
				}
				else {
					if (query !== null && query !== undefined && query !== '') {
						//going to perform a search query. The previous rquests array "needs" to be cleared
						this.requests = [];

						//querying by game title, so prepare query
						query = window.lfg.utils.clearWhiteSpace(query).toLowerCase();

						//using a custom index I created to reverse order entries
						requestsRef
							.orderByChild('gameindex')
							.startAt(query)
							.endAt(query + '~')
							.limitToFirst(this.dataops.limit)
							.on('child_added', function (snapshot) {
								customElem.push('requests', snapshot.val());
							});
					}
					else if (id !== null && id !== undefined && id !== '') {
						this.requests = [];
						requestsRef
							.orderByChild('giantbombindex')
							.startAt(id)
							.endAt(id + '~')
							.limitToFirst(this.dataops.limit)
							.on('child_added', function (snapshot) {
								customElem.push('requests', snapshot.val());
							});
					}
					else {
						requestsRef.orderByPriority()
							.limitToFirst(this.dataops.limit)
							.on("child_added", function (snapshot) {
								//add to the list of requests...polymer should do the rest via template 2-way binding awesomeness.
								customElem.push('requests', snapshot.val());
							}, function (errorObject) {
								console.log("The read failed: " + errorObject.code);
							});
					}
				}
            },*/

            showFilter: function () {
            	$(this.$.filter_modal).openModal();
            },

            showSearch: function () {
                $(this.$.search_dropdown).fadeIn(100, function () {
                    $('#search_input').focus();
                });
            },

            containerScroll: function (e) {
            	var container = e.target;
            	if ($(container).scrollTop() + $(container).innerHeight() >= e.target.scrollHeight) {
            		// reached bottom of page - run our call for pagination
            		//this.getRequests(polymer.dataops.sort, true, game.toLowerCase(), giantbombid);
            		this.getRequests(this.dataops.query, this.dataops.querytype, true);
            	}
            },

			/* Init */
            initializeData: function () {

            	this.firebaseUrl = window.lfg.config.getFirebaseUrl() + '/requests';

            	this.systems = [
					{ name: 'PC', value: 'pc' },
					{ name: 'PS3', value: 'ps3' },
					{ name: 'PS4', value: 'ps4' },
					{ name: 'Xbox 360', value: 'xbox360' },
					{ name: 'Xbox One', value: 'xboxOne' },
					{ name: 'Wii', value: 'wii' },
					{ name: 'Wii U', value: 'wiiu' }
            	];

            	this.sortoptions = [
					{ name: 'Date Created', column: 'created' },
					{ name: 'Game', column: 'game' },
            	];

            	this.querytype = {
            		bygame: 'bygame',
            		byid: 'byid',
					none: 'none'
            	};

            	this.dataops = {
					orderby: '',
            		sort: 'created',
            		filter: '',
            		query: '',
            		type: this.querytype.none,
					limit: 2,
            	}

            	this.firebaseRef = new Firebase(window.lfg.config.getFirebaseUrl());

            	this.requests = [];

                //hide elements
            	$(this.$.filter_modal).hide();
            	$(this.$.search_dropdown).hide();
            },

            registerEvents: function () {
            	var polymer = this;

            	$('#search_input').on('focusout', function () { $('#search_dropdown').fadeOut(100); })
            	$('#search_input').on('keypress', this.doSearch.bind(this));
            	$('#mainContainer').scroll(this.containerScroll.bind(this));
            	$(document).on('click', '.search-result-link', this.doResultSearchWithClick.bind(this));
            },

            registerPlugins: function() {
            	$(this.$.sort_menu).dropdown({
            		inDuration: 300,
            		outDuration: 225,
            		constrain_width: false, // Does not change width of dropdown to that of the activator
            		hover: false, // Activate on hover
            		gutter: 0, // Spacing from edge
            		belowOrigin: false // Displays dropdown below the button
            	});
            },

			/* Events */
            newRequest: function(){
                document.querySelector('app-router').go('/new');
            },

            ready: function () {
            	this.initializeData();
            },

            attached: function () {
            	//this.getRequests(this.dataops.sort);
            	this.getRequests(null, this.querytype.none, false);
            	this.registerPlugins();
            	this.registerEvents();
            }
        });
    })(window);
</script>