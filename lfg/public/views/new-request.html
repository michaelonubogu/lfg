<link rel="import" href="../components/bower_components/polymer/polymer.html">
<link rel="import" href="../imports/layout.html">

<!-- Fonts -->
<link rel='import' href='../components/bower_components/font-roboto/roboto.html'>

<link rel="import" href="../components/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/av-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/image-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/notification-icons.html">
<link rel="import" href="../components/bower_components/iron-icons/social-icons.html">

<link rel="import" href="../components/bower_components/iron-form/iron-form.html">

<link rel="import" href="../components/bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../components/bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../components/bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../components/bower_components/paper-item/paper-item.html">
<link rel="import" href="../components/bower_components/paper-button/paper-button.html">
<link rel="import" href="../components/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../components/bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../components/bower_components/paper-toolbar/paper-toolbar.html">

<!-- Custom Imports -->
<link rel="import" href="../imports/font-awesome.html">
<link rel="import" href="../imports/material_icons.html" />
<link rel="import" href="../imports/materialize.html" />
<link rel="import" href="../imports/side-nav-contents.html" />


<dom-module id="new-request">
    <style>
        :host{
        }

		.row .col {
			padding-left:0 !important;
		}

        .logo-link{
            text-decoration: none;
            font-size:1.5rem;
            color:#ffffff;
            margin-left:-15px !important;
        }

		#request_create_button {
			background-color: #EF6C00;
			color: #ffeb3b;
			width:100%;
		}

		#paper-header-panel{
            border-bottom: solid 1px #ffffff;
        }

		.picker__date-display {
			background-color: #fb8c00 !important;
		}

        .lfg-main-toolbar{
            --paper-toolbar-background:{
                 background-color: transparent !important;
             };
        }

        .lfg-drawer-toolbar{
            --paper-toolbar-background: #ef6c00;
        }

        .lfg-main-header-panel{
            --paper-header-panel-cover-container:{
                 border: solid 1px #ffffff;
             };
        }

        .lfg-paper-fab{
            --paper-fab: {
                 position: fixed;
                 right: 0;
                 bottom: 0;
                 margin-right: 3%;
                 margin-bottom: 3%;
             };
            --paper-fab-background: #e65100;
        }

        .lfg-input{
            color: #ffeb3b !important;
        }

		.lfg-input-search {
			color: #ef6c00;
		}

		.lfg-input.input-field textarea {
			border-bottom: 1px solid #ffffff;
            box-shadow: 0 1px 0 0 #ffffff;
		}

		.lfg-input.input-field textarea:focus {
			border-bottom: 1px solid #ffeb3b;
            box-shadow: 0 1px 0 0 #ffeb3b;
		}

        /* label color */
        .lfg-input.input-field label {
            color: #ffffff;
        }

        .lfg-input.input-field input[type=text]{
            border-bottom: 1px solid #ffffff;
            box-shadow: 0 1px 0 0 #ffffff;
            font-size: 1.75rem;
        }

		.lfg-input.input-field input[type=number]{
            border-bottom: 1px solid #ffffff;
            box-shadow: 0 1px 0 0 #ffffff;
            font-size: 1.5rem;
        }

		.lfg-input-search.input-field input[type=text]:focus {
			color: #ef6c00;
			border-bottom: 1px solid #f57c00 ;
            box-shadow: 0 1px 0 0 #f57c00 ;
		}

        /* label focus color */
        .lfg-input.input-field input[type=text]:focus + label {
            color: #ffeb3b;
        }

        /* label underline focus color */
        .lfg-input.input-field input[type=text]:focus {
            border-bottom: 1px solid #ffeb3b;
            box-shadow: 0 1px 0 0 #ffeb3b;
        }

		.lfg-input.input-field input[type=number]:focus {
            border-bottom: 1px solid #ffeb3b;
            box-shadow: 0 1px 0 0 #ffeb3b;
        }
        /* valid color */
        .lfg-input.input-field input[type=text].valid {
            border-bottom: 1px solid #ffffff;
            box-shadow: 0 1px 0 0 #ffffff;
        }

		.lfg-input.input-field input[type=number].valid {
            border-bottom: 1px solid #ffffff;
            box-shadow: 0 1px 0 0 #ffffff;
        }

		.lfg-input-search.input-field input[type=text].valid {
			color: #ef6c00;
			border-bottom: 1px solid #f57c00 ;
            box-shadow: 0 1px 0 0 #f57c00 ;
		}
        /* invalid color */
        .lfg-input.input-field input[type=text].invalid {
            border-bottom: 1px solid #f44336 !important;
            box-shadow: 0 1px 0 0 #f44336 !important;
        }

		.lfg-input.input-field input[type=number].invalid {
            border-bottom: 1px solid #f44336 !important;
            box-shadow: 0 1px 0 0 #f44336 !important;
        }

		.lfg-input .select-wrapper input.select-dropdown .invalid {
			border-bottom: 1px solid #f44336 !important;
            box-shadow: 0 1px 0 0 #f44336 !important;
		}

        /* Icon prefix */
        .lfg-input.input-field .prefix {
            color: #ffffff;
        }

        /* icon prefix focus color */
        .lfg-input.input-field .prefix.active {
            color: #ffeb3b;
        }

		.lfg-input-search.input-field .prefix {
			color: #9e9e9e ;
		}

		.lfg-input-search.input-field .prefix.active {
			color: #f57c00;
		}

		.lfg-input .select-wrapper input.select-dropdown{
			border-bottom: 1px solid #ffffff;
            box-shadow: 0 1px 0 0 #ffffff;
		}


        .switch label.new-request input[type=checkbox].new-request:checked + .lever.new-request{
            background-color: #fff59d;
        }

        .switch.new-request label.new-request input[type=checkbox].new-request:checked + .lever.new-request:after{
            background-color:#ffff00;
        }

        .switch.new-request label.new-request input[type=checkbox].new-request:checked + .positive.new-request{
            background-color:#ffff00 !important;
        }

        .switch.new-request label.new-request input[type=checkbox].new-request:checked + .negative.new-request:after{
            background-color:#ffff00 !important;
        }

        .bottom-bar{
            margin-left:0px !important;
        }

        .content-area{
            width:100%;
            padding:0 10% 10% 10%;
            background-color:#fb8c00;
        }

        .requests-card-panel{
            width: 100%;
            box-shadow: 0 2px 5px 0 #e65100;
            border-radius:0px;
        }

        .mic-required{
            margin-left: -35px !important;
        }

		.search-image {
			border-radius: 5px !important;
		}

        @media (max-width: 640px){
            .logo-link{
                margin-left:0px;
            }

            .content-area{
                padding: 0 5% 5% 5%;
            }

            .lfg-paper-fab{
                --paper-fab: {
                     position: fixed;
                     right: 0;
                     bottom: 0;
                     margin-right: 3.5%;
                     margin-bottom: 3.5%;
                 };
                --paper-fab-background: #e65100;
            }

            .mic-required{
                margin-left: 0 !important;
            }
        }

    </style>

    <template>
        <paper-drawer-panel>
            <paper-header-panel mode="seamed" drawer>
                <paper-toolbar class="medium-tall lfg-drawer-toolbar">

                </paper-toolbar>
                <div fit class="orange darken-3">
					<side-nav-contents></side-nav-contents>
				</div>
            </paper-header-panel>
            <paper-header-panel mode="scroll" main class="lfg-main-header-panel">
                <paper-toolbar class="medium-tall lfg-main-toolbar">
                    <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
                    <paper-icon-button icon="arrow-back" on-click="goToList"></paper-icon-button>
                    <div flex></div>
                    <!--<paper-icon-button icon="search"></paper-icon-button>
                    <paper-icon-button icon="more-vert"></paper-icon-button>-->
                    <div class="middle">
                    </div>
                    <div class="title bottom">
                        <template is="dom-if" if="{{!saveSuccess}}">
							<a href="/" class="logo-link">New Gaming Request</a>
						</template>
                    </div>
                </paper-toolbar>
                <div fit class="content-area">
                    <br>

					<div id="new_request_form">
						<!--Request Activity-->
						<div class="row">
							<div class="col s12">
								<i class="mdi-action-grade white-text" style="margin-right:10px; font-size:1.5rem;"></i>
								<label class="white-text light" style="font-size:1rem; margin-top: 7.5px; position:absolute;">What is it you want to do?</label>
							</div>
							<div class="lfg-input input-field col s12">
								<input id="request_title" type="text" class="validate" value="{{request.title::input}}" />
							</div>
						</div>

						<!--System-->
						<div class="row">
							<div class="col s12">
								<i class="mdi-hardware-tv white-text" style="margin-right:10px; font-size:1.5rem;"></i>
								<label class="white-text light" style="font-size:1rem; margin-top: 7.5px; position:absolute;">For which system?</label>
							</div>
							<div class="lfg-input select input-field col s12">
								<select id="request_system">
									<option value="" disabled selected></option>
								</select>
							</div>
						</div>

						<!--Video Game-->
						<div class="row" style="margin-top:40px;">
							<div class="col s12">
								<i class="mdi-hardware-gamepad white-text" style="margin-right:10px; font-size:1.5rem;"></i>
								<label class="white-text light" style="font-size:1rem; margin-top: 7.5px; position:absolute;">In what game?</label>
							</div>
							<div class="row" style="margin-top:40px;">
								<div class="lfg-input input-field col s10">
									<input id="selected_game" type="text" class="validate" readonly placeholder="Click the yellow search button">
								</div>
								<div class="col s2" style="margin-top: 26px;">
									<a style="width:100%;" class="waves-effect waves-block-light btn yellow accent-2 orange-text text-darken-3 modal-trigger" href="#game_tag">
										<i class="material-icons">search</i>
									</a>
								</div>
							</div>
						</div>


						<!--Time-->
						<div class="row date-right-now" style="margin-top:35px;">
							<div class="col s12 m6 l4">
								<i class="material-icons white-text" style="margin-right:10px; font-size:1.5rem;">access_time</i>
								<label class="white-text light" style="font-size:1rem; margin-top: 3px; position:absolute;">When do you want to play?</label>
							</div>
							<div class="col s12 m6 l8">
								<label class="yellow-text text-accent-2 light" style="font-size:1.5rem; margin-right:2rem;">Right Now (Default)</label>
								<span class="white-text thin">or</span>
								<span>
									<a class=" btn-flat white-text" on-click="showDateSelection">
										<i class="material-icons left">today</i>
										<span style="text-transform:none;">Pick a Date & Time</span>
									</a>
								</span>
							</div>
						</div>

						<div class="row date-selection" style="margin-top:45px; display:none;">
							<div class="col s7" style="margin-left:0;">
								<div class="col s12">
									<i class="mdi-action-today white-text" style="margin-right:10px; font-size:1.5rem;"></i>
									<label class="white-text light" style="font-size:1rem; margin-top: 7.5px; position:absolute;">On what day?</label>
								</div>
								<div class="lfg-input input-field col s12">
									<input id="request_date" type="date" class="datepicker" value={{request.date::input}}>
								</div>
							</div>
							<div class="col s5">
								<div class="col s12">
									<i class="mdi-device-access-time white-text" style="margin-right:10px; font-size:1.5rem;"></i>
									<label class="white-text light" style="font-size:1rem; margin-top: 7.5px; position:absolute;">At what time?</label>
								</div>
								<div class="lfg-input input-field col s12">
									<input id="request_time" type="text" class="validate" value={{request.time::input}}>
								</div>
							</div>
						</div>

						<!--Players-->
						<div class="row" style="margin-top:40px;">
							<div class="col s12">
								<i class="material-icons white-text" style="margin-right:10px; font-size:1.5rem;">accessibility</i>
								<label class="white-text light" style="font-size:1rem; margin-top: 3px; position:absolute;">Players needed?</label>
							</div>
							<div class="lfg-input input-field col s12">
								<input id="request_gamer_count" type="text" min="1" value={{request.gamercount::input}}>
							</div>
						</div>

						<!--Gamer tag-->
						<div class="row" style="margin-top:40px;">
							<div class="col s12">
								<i class="mdi-action-picture-in-picture white-text" style="margin-right:10px; font-size:1.5rem;"></i>
								<label class="white-text light" style="font-size:1rem; margin-top: 3px; position:absolute;">What's your gamer tag? (Optional)</label>
							</div>
							<div class="lfg-input input-field col s12">
								<input id="request_gamertag" type="text" class="validate" value={{request.gamertag::input}}>
							</div>
						</div>


						<!--Description-->
						<div class="row" style="margin-top:40px;">
							<div class="col s12">
								<i class="material-icons white-text" style="margin-right:10px; font-size:1.5rem;">assignment</i>
								<label class="white-text light" style="font-size:1rem; margin-top: 3px; position:absolute;">Tell us more about what you want to do (Optional)</label>
							</div>
							<div class="lfg-input input-field col s12">
								<textarea id="request_description" type="text" spellcheck="false" class="materialize-textarea" length="250" value={{request.description::input}}></textarea>
							</div>
						</div>

						<!--Mics-->
						<div class="row" style="margin-top:40px;">
							<div class="col s1" style="margin-top: -15px;">
								<i class="mdi-hardware-headset-mic white-text" style="font-size:2rem;"></i>
							</div>
							<div class="col s5 mic-required"><label class="white-text" style="font-size:1rem;">Are microphones required?</label></div>
							<div class="col s4">
								<div class="switch">
									<label class="white-text" style="font-size:1rem;">
										<span class="negative">No</span>
										<input type="checkbox" checked="{{request.mic::change}}">
										<span class="lever"></span>
										<span class="positive">Yes</span>
									</label>
								</div>
							</div>
						</div>

						<div class="row" style="margin-top:40px;">
							<div class="col s12">
								<paper-button id="request_create_button" raised on-click="saveRequest">
									<iron-icon icon="done"></iron-icon>
									Create Gaming Request
								</paper-button>
							</div>
						</div>
						<br /><br />
					</div>

					<div id="success_message" class="center-align" style="display:none;">
						<h4 class="white-text">Your Gaming Request was created!</h4>
						<h5 class="white-text">Now go tell the world about it!</h5>
						<br /><br /><br />
						<div class="row">
							<div style="margin:0 auto;">
								<div style="display:inline-block; padding:0 5%;"><a href="#" class="white-text"><i class="fa fa-facebook-square fa-4x"></i></a></div>
								<div style="display:inline-block; padding:0 5%;"><a href="#" class="white-text"><i class="fa fa-twitter fa-4x"></i></a></div>
								<div style="display:inline-block; padding:0 5%;"><a href="#" class="white-text"><i class="fa fa-google-plus fa-4x"></i></a></div>
							</div>
						</div>
					</div>
                </div>
            </paper-header-panel>
        </paper-drawer-panel>

		<div id="game_tag" class="modal">
			<div class="modal-content">
				<h5>Tag a video game to your request</h5>

				<div class="game-title-search" >
					<div class="lfg-input-search input-field col s12">
						<i class="material-icons prefix">search</i>
						<input id="search_request_game" type="text" class="lfg-input-search validate" placeholder="The name of the game you want tagged to your request">
					</div>
				</div>
				<br />
				<div class="game-title-results">
					<table id="search_results_table">
						<tbody>
							<tr><td>Results show up here :}</td></tr>
							<!--<tr><td class="search-result-row">
								<div class="row" style="margin-bottom:0px;">
									<div class="col 3">
										<img class="search-image" src="../assets/app/img/destiny.jpg" width="100" />
									</div>
									<div class="col 9" style="margin-top:18px;">
										<span style="font-size:1.15rem;">Destiny</span>
										<input class="search-item-id" />
									</div>
								</div>
								</td></tr>-->
						</tbody>
					</table>
				</div>
			</div>
		</div>
    </template>
</dom-module>

<script>
	(function (window) {
        var constructor = Polymer({

            is: 'new-request',

            /**
             * ...
             *
             * @attribute properties
             * @type object
             * @default
             */
            properties: {
                elementname: 'New Request Page',
                /**
                 * ...
                 *
                 * @attribute thingName
                 * @type string
                 * @default ''
                 */
            },

            convertDateToUtc: function (date) {
            	return window.lfg.utils.convertDateToUtc(date);
            },

            doVideoGameSearch: function (e) {
            	var query = $(e.target).val();
            	var cusElem = this;

            	if (query.length > 2) {
            		//perform giantbomb search
            		var url = window.lfg.config.getGiantBombUrl(window.lfg.config.apiEndPoints.search);
            		var limit = 4;

            		$.ajax({
            			url: url,
            			type: 'GET',
            			cache: false,
            			data: { search: query, limit: limit },
            			dataType: 'json',
            			success: function (data) {
            				var listHtml = '';
            				_.each(data.results, function (element, index) {
            					listHtml += '<tr class="search-result-row"><td >';
            					listHtml += '<div class="row" style="margin-bottom:0px;">';
            					listHtml += '<div class="col 3">';

            					if (
									element.image !== null && element.image !== undefined &&
									element.image.screen_url !== null &&
									element.image.screen_url !== undefined &&
									element.image.screen_url !== '') {
            						listHtml += '<img class="search-image" style="border-radius: 5px !important;" src="' + element.image.screen_url + '" width="100" />';
            					}
            					else {
            						listHtml += '<div style="background-color:#FB8C00; width:100px; height:56px;"></div>';
            					}

            					listHtml += '</div>';
            					listHtml += '<div class="col 9" style="margin-top:18px;">';
            					listHtml += '<span class="game-title" style="font-size:1.15rem;">' + element.name + '</span>';
            					listHtml += '<input class="search-item-id" type="hidden" value="' + element.id + '" />';
            					listHtml += '</div>';
            					listHtml += '</div>';
            					listHtml += '</td></tr>';
            				});

            				$(cusElem.$.search_results_table).find('tbody').html(listHtml);
            			},
            			error: function (err) {
            			}
            		});
            	}
            	else {
					//Replace with searching row
            	}
            },

            getLookupData: function(){
                //Gets lookup data from Giant Bomb
                var config = window.lfg.config;
                $.get(config.appUrl)
            },

            goToList: function () {
            	document.querySelector('app-router').go('/requests');
            },

            searchRowClick: function (e) {
            	
            	var cusElem = this;
            	$(this.$.selected_game).removeClass('invalid');
            	$(cusElem.$.selected_game_error).hide();

            	var element = e.target;
            	if (element.tagName.toLowerCase() !== 'tr') {
            		element = $(e.target).parents('tr').get(0);
            	}

            	//Get the url and the gametitle
            	cusElem.request.game = $(element).find('.game-title').html();
            	cusElem.request.gameid = $(element).find('.search-item-id').val();
            	var imageUrl = $(element).find('.search-image').attr('src');

            	if (imageUrl !== null && imageUrl !== undefined && imageUrl !== '') {
            		//cusElem.request.images.list_url = window.lfg.utils.convertToBase64(imageUrl);
            		cusElem.request.images.list_url = imageUrl;
            	}
            	
            	$(cusElem.$.selected_game).val(cusElem.request.game);

            	//close modal
            	$(cusElem.$.game_tag).closeModal();
            },

            initializeData: function () {

            	this.saveSuccess = false;

            	this.request = {
            		title: '',
            		game: '',
					gameid: '',
            		system: '',
            		date: '',
            		time: '',
            		gamercount: '1',
            		gamertag: '',
					description: '',
					mic: false,
					images: {
						list_url: '',
						profile_url: ''
					},
					customDate: false
            	};

            	this.systems = [
					{ name: 'PC', value: 'pc' },
					{ name: 'PS3', value: 'ps3' },
					{ name: 'PS4', value: 'ps4' },
					{ name: 'Xbox 360', value: 'xbox360' },
					{ name: 'Xbox One', value: 'xboxOne' },
					{ name: 'Wii', value: 'wii' },
					{ name: 'Wii U', value: 'wiiu' }
            	];

            	this.firebaseRef = new Firebase(window.lfg.config.getFirebaseUrl());
            },

            optionSelected: function (e) {
            	var node = $('new-request')[0];
            	var select = e.target;
            	var val = $(select).val();
            	node.__data__.request.system = val;  //This is the only way I know how to get properties declared on a Polymer custom element, 
            	//when accessed outside of Polymer's context. I suspect theres a beter way than using the "__data__" prop

            	//clear val errors
            	$('#request_system').parent().find('.select-dropdown').removeClass('invalid');
            },

			
            registerPlugins: function () {

            	$('.modal-trigger').leanModal();

            	$(this.$.request_date).pickadate({
            		selectMonths: true,
					selectYears: 15
            	});

            	$(this.$.request_time).timeEntry({
            		spinnerImage: ''
            	});

            	$(this.$.request_details_container).collapsible();

            	$(this.$.request_game).autocomplete({
            		source: function (request, response) {
            			var url = window.lfg.config.getGiantBombUrl(window.lfg.config.apiEndPoints.search);

            			$.ajax({
            				url: url,
            				type: 'GET',
            				cache: false,
            				data: { search: request.term },
            				dataType: 'json',
            				success: function (data) {
            					response($.map(data.results, function (item) {
            						return {
            							label: item.name,
										value: item.id
            						}
            					}));
            				},
            				error: function (err) {
            				}
            			});
            		},
            		minLength: 1,
            		select: function (event, ui) {
            			event.preventDefault();
            			$('#' + this.id).val(ui.item.label);
            			$('#request_game_id').val(ui.item.value);

            			var node = $('new-request')[0];
            			node.__data__.request.game = ui.item.label;  //This is the only way I know how to get properties declared on a Polymer custom element, when accessed outside of Polymer's context. I suspect theres a beter way than using the "__data__" prop
            			node.__data__.request.gameid = ui.item.value;
            		},
            		messages: {
            			noResults: 'Could not find game title',
            			results: function () { }
            		},
            		open: function () {
            			$('.ui-autocomplete').width($(this).width()); //this is the input field
            		}
            	});
            },

            registerEvents: function () {
            	$(document).on('change', '#' + this.$.request_date.id, function () {
            		$(this).removeClass('invalid');
            	});

            	$(document).on('keypress', '#request_gamer_count', this.verifyDigitOnly.bind(this));
            	$(document).on('input', '#search_request_game', this.doVideoGameSearch.bind(this));
            	$(document).on('click', '.search-result-row', this.searchRowClick.bind(this));
            },

            registerDropListPlugin: function () {
            	//TODO: Add Options manually or Use "browser-default" class of materialselect (lame) | <DONE>
				var list = ''
				_.each(this.systems, function (system) {
					list += '<option value="' + system.value + '">' + system.name + '</option>'
				});
				$(this.$.request_system).append(list);


				$(this.$.request_system).material_select();
				$(this.$.request_city).material_select();
				$(this.$.request_state).material_select();

				//option selected event
				$(document).on('change', '#' + this.$.request_system.id, this.optionSelected);
            },

            showSuccessMessage: function () {
            	this.saveSuccess = true;
            	$(this.$.new_request_form).hide(0, function () {
            		$('#success_message').fadeIn();
            	});
            },

            saveRequest: function () {
            	//get the values of plugin-affected inputs
            	var time_date = $(this.$.request_time).timeEntry('getTime');
            	this.request.date = $(this.$.request_date).pickadate('picker').get('select', 'mm/dd/yyyy');
            	this.request.time = time_date !== null && time_date !== undefined && time_date !== '' ? time_date : null;

            	var authJSON = sessionStorage.getItem(window.lfg.config.firebaseCacheKey);
            	var authData = JSON.parse(authJSON);

            	if (authData == null || authData == undefined) {
            		var localJSON = localStorage.getItem(window.lfg.config.firebaseCacheKey);
            		authData = JSON.parse(localJSON);
            	}

            	if (this.validateGameRequest(this.request) !== false && authData !== null && authData !== undefined) {

					//If the date or time is null, do this
            		if (this.request.time == null || this.request.time) {
            			this.request.time = Date.now();
            		}

            		var request_date = this.request.date == null || this.request.date == undefined || this.request.date == '' ? Date.now() : Date.parse(this.request.date);

            		this.request.time.setFullYear(request_date.getFullYear());
            		this.request.time.setMonth(request_date.getMonth(), request_date.getDate());
            		this.request.time.setDate(request_date.getDate());
            		
            		var utcDate = this.convertDateToUtc(this.request.time);
            		var createdUTC = this.convertDateToUtc(new Date.now());

            		var requestsRef = this.firebaseRef.child('requests');
            		var newRequest = {
            			title: this.request.title,
            			game: this.request.game.toLowerCase(),
            			gametitle: this.request.game,
            			giantbombid: this.request.gameid,
            			gamercount: this.request.gamercount,
            			system: this.request.system,
            			datetime: utcDate,
            			mic: this.request.mic,
            			description: this.request.description,
            			created: createdUTC,
            			uid: authData.uid,
            			images: this.request.images
            		}

					//Firebase Search Indexes
            		//custom index for searching & ordering requests in lexicographical/chronologic order -  really just a hack
            		var lexicoIndex = window.lfg.utils.getSearchIndex(this.convertDateToUtc(Date.now()));

            		newRequest.gameindex = window.lfg.utils.clearWhiteSpace(newRequest.game) + lexicoIndex;
            		newRequest.giantbombindex = newRequest.giantbombid + lexicoIndex;
            		newRequest.systemgameindex = newRequest.system + newRequest.gameindex;

            		//Save new request content;
            		var newRequestRef = requestsRef.push(newRequest);

            		newRequestRef.setWithPriority(newRequest, 0 - Date.now());	//Set the priority so that this comes first 
            		var requestid = newRequestRef.key();

            		if (requestid !== null && requestid !== undefined)
            			this.showSuccessMessage();
            	}
            },

            showDateSelection: function () {
            	this.request.customDate = true;
            	$('.date-right-now').hide(0, function () {
            		$('.date-selection').show();
            	});
            },

            validateGameRequest: function (request) {
            	var valid = true;

            	if (request.gameid == null || request.gameid == undefined || request.gameid == '') {
            		$(this.$.selected_game).addClass('invalid');
            		valid = false;
            	}

            	if (request.title === null || request.title === undefined || request.title === '') {
            		$(this.$.request_title).addClass('invalid');
            		valid = false;
            	}

            	if (request.game === null || request.game === undefined || request.game === '') {
            		$(this.$.request_game).addClass('invalid');
            		valid = false;
            	}

            	if (request.gamercount !== null && request.gamercount !== undefined && request.gamercount !== '') {
            		if (!$.isNumeric(request.gamercount)) {
            			$(this.$.request_gamer_count).addClass('invalid');
            			valid = false;
            		}
            	}

            	if (request.system === null || request.system === undefined || request.system === '') {
            		$(this.$.request_system).parent().find('.select-dropdown').addClass('invalid');
            		valid = false;
            	}

            	if (request.customDate) {
            		if (request.date === null || request.date === undefined || request.date === '') {
            			$(this.$.request_date).addClass('invalid');
            			valid = false;
            		}

            		if (request.time === null || request.time === undefined || request.time === '') {
            			$(this.$.request_time).addClass('invalid');
            			valid = false;
            		}
            	}

            	return valid;
            },

            verifyDigitOnly: function (e) {
            	//if the letter is not digit then display error and don't type anything
            	if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {
            		return false;
            	}
            	return true;
            },

            created: function () {
				//Part of Polymer lifecycle
            },

            ready: function () {
            	this.initializeData();
            },

            attached: function () {
				//called after ready();
            	this.registerPlugins();
            	this.registerDropListPlugin();
            	this.registerEvents();
            }
        });
    })(window);
</script>